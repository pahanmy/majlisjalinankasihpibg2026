<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Majlis Jalinan Kasih PIBG Miri 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; color: black; }
            .card { border: 1px solid #ddd; box-shadow: none; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useMemo } = React;

        // --- Firebase Config (Sama seperti index.html) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIm-osCUz7axIBCvz77JLyvzmRSGBahoo",
            authDomain: "jalinankasih-26624.firebaseapp.com",
            projectId: "jalinankasih-26624",
            storageBucket: "jalinankasih-26624.firebasestorage.app",
            messagingSenderId: "656439611876",
            appId: "1:656439611876:web:8da176755e3d59ee3177f1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'jalinankasih-web'; // Mesti sama dengan index.html

        // --- Icons ---
        const Icon = ({ name, className }) => {
            const icons = {
                Users: <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
                DollarSign: <><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>,
                School: <><path d="m4 6 8-4 8 4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M14 22v-4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v4"/><path d="M18 5v17"/><path d="M6 5v17"/><circle cx="12" cy="9" r="2"/></>,
                Printer: <><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></>,
                Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
                Trash2: <><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>,
                ChevronDown: <path d="m6 9 6 6 6-6"/>,
                ChevronUp: <path d="m18 15-6-6-6 6"/>
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        function AdminDashboard() {
            const [user, setUser] = useState(null);
            const [data, setData] = useState([]);
            const [expandedRow, setExpandedRow] = useState(null);

            // Auth Setup
            useEffect(() => {
                const initAuth = async () => {
                    try { await signInAnonymously(auth); } catch (e) { console.error(e); }
                };
                initAuth();
                onAuthStateChanged(auth, setUser);
            }, []);

            // Data Fetching
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'miri_dinner_rsvps'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort by newest first
                    fetchedData.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setData(fetchedData);
                });
                return () => unsubscribe();
            }, [user]);

            const toggleExpand = (id) => {
                if (expandedRow === id) setExpandedRow(null);
                else setExpandedRow(id);
            };

            const handleDelete = async (id, name) => {
                if(window.confirm(`Adakah anda pasti mahu memadam rekod sekolah: ${name}?`)) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'miri_dinner_rsvps', id));
                    } catch (err) {
                        alert("Gagal memadam rekod.");
                    }
                }
            };

            // Calculations
            const totalSchools = data.length;
            const totalPax = data.reduce((acc, curr) => acc + (curr.attendees?.length || 0), 0);
            const totalAmount = data.reduce((acc, curr) => acc + (curr.totalAmount || 0), 0);

            return (
                <div className="min-h-screen bg-gray-50 pb-12">
                    {/* Header */}
                    <div className="bg-white border-b border-gray-200 sticky top-0 z-10 no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-3">
                                    <div className="bg-blue-600 text-white p-2 rounded-lg"><Icon name="School" className="w-5 h-5" /></div>
                                    <span className="font-bold text-lg text-gray-800 hidden sm:block">Admin - Jalinan Kasih 2026</span>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button onClick={() => window.print()} className="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition text-sm font-medium">
                                        <Icon name="Printer" className="w-4 h-4" /> Cetak
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 no-print">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-sm font-medium text-gray-500 uppercase tracking-wider">Jumlah Sekolah</h3>
                                    <div className="p-2 bg-blue-50 text-blue-600 rounded-lg"><Icon name="School" className="w-5 h-5" /></div>
                                </div>
                                <p className="text-3xl font-bold text-gray-900">{totalSchools}</p>
                                <p className="text-xs text-gray-400 mt-1">Sekolah mendaftar</p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-sm font-medium text-gray-500 uppercase tracking-wider">Jumlah Peserta</h3>
                                    <div className="p-2 bg-green-50 text-green-600 rounded-lg"><Icon name="Users" className="w-5 h-5" /></div>
                                </div>
                                <p className="text-3xl font-bold text-gray-900">{totalPax}</p>
                                <p className="text-xs text-gray-400 mt-1">Orang hadir</p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-sm font-medium text-gray-500 uppercase tracking-wider">Anggaran Kutipan</h3>
                                    <div className="p-2 bg-yellow-50 text-yellow-600 rounded-lg"><Icon name="DollarSign" className="w-5 h-5" /></div>
                                </div>
                                <p className="text-3xl font-bold text-gray-900">RM {totalAmount.toLocaleString()}</p>
                                <p className="text-xs text-gray-400 mt-1">Berdasarkan pendaftaran</p>
                            </div>
                        </div>

                        {/* Print Header (Visible only when printing) */}
                        <div className="hidden print-only mb-8 text-center">
                            <h1 className="text-2xl font-bold">Laporan Pendaftaran Majlis Jalinan Kasih PIBG 2026</h1>
                            <p className="text-gray-600">Tarikh Cetakan: {new Date().toLocaleDateString('ms-MY')}</p>
                        </div>

                        {/* Table */}
                        <div className="bg-white shadow-sm rounded-xl border border-gray-200 overflow-hidden card">
                            <div className="p-6 border-b border-gray-200 flex justify-between items-center no-print">
                                <h3 className="font-bold text-lg text-gray-800">Senarai Pendaftaran Terkini</h3>
                                <span className="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full">{data.length} Rekod</span>
                            </div>
                            
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                            <th className="p-4 w-10 text-center">#</th>
                                            <th className="p-4">Nama Sekolah</th>
                                            <th className="p-4">Pegawai Perhubungan (PIC)</th>
                                            <th className="p-4 text-center">Pax</th>
                                            <th className="p-4 text-right">Jumlah (RM)</th>
                                            <th className="p-4 text-center no-print">Tindakan</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {data.length === 0 ? (
                                            <tr>
                                                <td colSpan="6" className="p-8 text-center text-gray-400">Tiada data pendaftaran dijumpai.</td>
                                            </tr>
                                        ) : (
                                            data.map((row, index) => (
                                                <React.Fragment key={row.id}>
                                                    <tr className={`hover:bg-gray-50 transition ${expandedRow === row.id ? 'bg-blue-50/30' : ''}`}>
                                                        <td className="p-4 text-center text-gray-400 text-sm">{index + 1}</td>
                                                        <td className="p-4">
                                                            <p className="font-bold text-gray-900">{row.schoolName}</p>
                                                            <p className="text-xs text-gray-400 mt-0.5">{row.timestamp ? new Date(row.timestamp.seconds * 1000).toLocaleString('ms-MY') : ''}</p>
                                                        </td>
                                                        <td className="p-4">
                                                            <p className="text-sm font-medium text-gray-800 uppercase">{row.contactName || '-'}</p>
                                                            <div className="flex items-center gap-1 text-xs text-gray-500 mt-1">
                                                                <Icon name="Phone" className="w-3 h-3" /> {row.contactNumber || '-'}
                                                            </div>
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            <span className="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                {row.attendees?.length || 0}
                                                            </span>
                                                        </td>
                                                        <td className="p-4 text-right font-mono text-sm text-gray-700">
                                                            {row.totalAmount?.toLocaleString()}
                                                        </td>
                                                        <td className="p-4 text-center no-print">
                                                            <div className="flex items-center justify-center gap-2">
                                                                <button 
                                                                    onClick={() => toggleExpand(row.id)}
                                                                    className="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition"
                                                                    title="Lihat Peserta"
                                                                >
                                                                    {expandedRow === row.id ? <Icon name="ChevronUp" className="w-4 h-4" /> : <Icon name="ChevronDown" className="w-4 h-4" />}
                                                                </button>
                                                                <button 
                                                                    onClick={() => handleDelete(row.id, row.schoolName)}
                                                                    className="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition"
                                                                    title="Padam Rekod"
                                                                >
                                                                    <Icon name="Trash2" className="w-4 h-4" />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {/* Expanded Detail Row */}
                                                    {expandedRow === row.id && (
                                                        <tr className="bg-gray-50/50 print-visible">
                                                            <td colSpan="6" className="p-4 pl-14">
                                                                <div className="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                                                                    <h4 className="text-xs font-bold uppercase text-gray-500 mb-3 tracking-wider border-b border-gray-100 pb-2">Senarai Nama Peserta</h4>
                                                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                                                                        {row.attendees && row.attendees.map((person, idx) => (
                                                                            <div key={idx} className="flex items-center justify-between text-sm p-2 bg-gray-50 rounded border border-gray-100">
                                                                                <span className="font-medium text-gray-700 uppercase truncate w-3/4">{person.name}</span>
                                                                                <span className="text-xs text-gray-500 bg-white px-2 py-0.5 rounded border border-gray-200 shadow-sm">{person.position || 'Peserta'}</span>
                                                                            </div>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    )}
                                                </React.Fragment>
                                            ))
                                        )}
                                    </tbody>
                                    <tfoot className="bg-gray-50 font-bold text-gray-900 border-t-2 border-gray-200">
                                        <tr>
                                            <td colSpan="3" className="p-4 text-right uppercase tracking-wider text-xs">Total Keseluruhan</td>
                                            <td className="p-4 text-center bg-blue-50 text-blue-900">{totalPax}</td>
                                            <td className="p-4 text-right bg-yellow-50 text-yellow-900 font-mono">RM {totalAmount.toLocaleString()}</td>
                                            <td className="no-print"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminDashboard />);
    </script>
</body>
</html>
